---
# 1Ô∏è‚É£ Gather required facts
- name: Gather system facts
  setup:

# 2Ô∏è‚É£ Stop and disable firewall
#- name: Stop and disable firewalld service
#  import_tasks: firewall.yaml

# 3Ô∏è‚É£ Install K3s on the master node
- name: Install K3s on the Master
  import_tasks: install_k3s_master.yaml
  when: inventory_hostname in groups['k3smaster']

# 4Ô∏è‚É£ Retrieve K3s token from the master
- name: Retrieve K3s Token from Master
  import_tasks: retrieve_token.yaml
  when: inventory_hostname in groups['k3smaster']

# 5Ô∏è‚É£ Save the token for Jenkins
- name: Save K3s Token to Jenkins Workspace
  import_tasks: save_token.yaml
  when: inventory_hostname in groups['k3smaster']

# 6Ô∏è‚É£ Fetch K3s token to the Jenkins control node
- name: Fetch K3s Token to Jenkins Server
  import_tasks: fetch_token.yaml
  when: inventory_hostname in groups['k3smaster']

# 7Ô∏è‚É£ Debug to confirm token retrieval
- name: Debug - Show Retrieved K3s Token
  import_tasks: debug_token.yaml
  when: inventory_hostname in groups['k3smaster']

# 8Ô∏è‚É£ Install K3s on the worker nodes
- name: Install K3s on Worker Nodes
  import_tasks: install_k3s_workers.yaml
  when: inventory_hostname in groups['k3snodes']

# 9Ô∏è‚É£ Distribute K3s token to worker nodes
- name: Distribute K3s Token to Worker Nodes
  import_tasks: distribute_token.yaml
  when: inventory_hostname in groups['k3snodes']

# üîü Debug token on worker nodes
- name: Debug - Verify Token on Worker Nodes
  import_tasks: debug_token_workers.yaml
  when: inventory_hostname in groups['k3snodes']

# 1Ô∏è‚É£1Ô∏è‚É£ Deploy MetalLB
- name: Deploy MetalLB
  import_tasks: deploy_metallb.yaml
  when: inventory_hostname in groups['k3smaster']

# 1Ô∏è‚É£2Ô∏è‚É£ Verify the complete setup
- name: Final verification of K3s installation
  import_tasks: verify_install.yaml
